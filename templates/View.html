<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>3D GeoJSON Viewer</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; overflow: hidden;
    font-family: 'Segoe UI', sans-serif;
  }

  #mainContainer {
    display: flex; height: 100%; width: 100%;
  }

  #cesiumContainer {
    flex-grow: 1;
    background-color: white;
  }

  #sidebar {
    width: 300px;
    background: #1e1e1e;
    color: #ddd;
    overflow-y: auto;
    border-left: 1px solid #333;
    padding: 15px;
    box-sizing: border-box;
  }

  #sidebar h4 {
    font-size: 18px;
    margin-bottom: 12px;
    color: #00bcd4;
    border-bottom: 1px solid #333;
    padding-bottom: 4px;
  }

  .jstree-default .jstree-anchor { color: #eee; font-size: 14px; }
  .jstree-default .jstree-icon { background-size: contain; background-repeat: no-repeat; }

  /* Icon overrides */
  .jstree-default .cad > .jstree-anchor > .jstree-icon {
    background-image: url('https://img.icons8.com/ios-filled/16/ffffff/home.png');
  }
  .jstree-default .reg > .jstree-anchor > .jstree-icon {
    background-image: url('https://img.icons8.com/ios-filled/16/ffffff/document.png');
  }
  .jstree-default .floor > .jstree-anchor > .jstree-icon {
    background-image: url('https://img.icons8.com/ios-filled/16/ffffff/floor-plan.png');
  }
  .jstree-default .type > .jstree-anchor > .jstree-icon {
    background-image: url('https://img.icons8.com/ios-filled/16/ffffff/box.png');
  }
  .jstree-default .subtype > .jstree-anchor > .jstree-icon {
    background-image: url('https://img.icons8.com/ios-filled/16/ffffff/structure.png');
  }

  /* Scrollbar */
  #sidebar::-webkit-scrollbar {
    width: 6px;
  }

  #sidebar::-webkit-scrollbar-thumb {
    background-color: #555;
    border-radius: 10px;
  }
</style>

</head>
<body>
<div id="mainContainer">
  <div id="cesiumContainer"></div>
  <div id="sidebar">
    <h4>GeoJSON Structure</h4>
    <div id="jstree-panel"></div>
  </div>
</div>
<script>
  const inputGeojson = {{ geojson_data | safe }};
  const viewer = new Cesium.Viewer("cesiumContainer", {
    animation: false,
    timeline: false,
    baseLayerPicker: false,
    skyBox: false,
    skyAtmosphere: false,
    geocoder: false,
    homeButton: false,
    sceneModePicker: false,
    navigationHelpButton: false,
    infoBox: true,
    selectionIndicator: true,
    fullscreenButton: false,
    sceneMode: Cesium.SceneMode.SCENE3D
  });
  viewer.scene.backgroundColor = Cesium.Color.WHITE;
  proj4.defs("EPSG:32638", "+proj=utm +zone=38 +datum=WGS84 +units=m +no_defs");

  const subtypeEntityMap = {}; // subtype â†’ [entities]

  function reprojectGeoJSON(geojson) {
    return {
      type: "FeatureCollection",
      features: geojson.features.map(feature => {
        const coords = feature.geometry.coordinates[0].map(pt =>
          proj4("EPSG:32638", "EPSG:4326", pt)
        );
        return {
          type: "Feature",
          geometry: { type: "Polygon", coordinates: [coords] },
          properties: feature.properties
        };
      })
    };
  }

  function buildJsTreeData(features) {
    const treeData = [];
    const idSet = new Set();
    for (const f of features) {
      const p = f.properties;
      const CADCODE = p.CADCODE || "??";
      const REG_N = p.REG_N || "??";
      const FLOOR = String(p.FLOOR || "??");
      const TYPE = p.TYPE || "??";
      const SUB_TYPE = p.SUB_TYPE || "??";

      const ids = [
        `cad:${CADCODE}`,
        `cad:${CADCODE}/reg:${REG_N}`,
        `cad:${CADCODE}/reg:${REG_N}/floor:${FLOOR}`,
        `cad:${CADCODE}/reg:${REG_N}/floor:${FLOOR}/type:${TYPE}`,
        `cad:${CADCODE}/reg:${REG_N}/floor:${FLOOR}/type:${TYPE}/subtype:${SUB_TYPE}`
      ];

      const texts = [CADCODE, REG_N, `Floor ${FLOOR}`, TYPE, SUB_TYPE];

      for (let i = 0; i < ids.length; i++) {
        const id = ids[i];
        const parent = i === 0 ? "#" : ids[i - 1];
        if (!idSet.has(id)) {
          idSet.add(id);
          treeData.push({ id, parent, text: texts[i], state: { opened: true } });
        }
      }
    }
    return treeData;
  }

  function initializeJsTree(treeData) {
  $('#jstree-panel').jstree('destroy');
  $('#jstree-panel').jstree({
    core: {
      data: treeData.map(node => {
        // assign a class for icons
        if (node.id.includes("cad:")) node.li_attr = { class: "cad" };
        if (node.id.includes("/reg:")) node.li_attr = { class: "reg" };
        if (node.id.includes("/floor:")) node.li_attr = { class: "floor" };
        if (node.id.includes("/type:")) node.li_attr = { class: "type" };
        if (node.id.includes("/subtype:")) node.li_attr = { class: "subtype" };
        return node;
      }),
      themes: { stripes: true }
    },
    plugins: ["checkbox"]
  });

  $('#jstree-panel').on('changed.jstree', function (e, data) {
    const visibleSubtypes = new Set();
    data.selected.forEach(id => {
      if (id.includes("subtype:")) {
        const subtype = id.split("subtype:")[1];
        visibleSubtypes.add(subtype);
      }
    });
    for (const subtype in subtypeEntityMap) {
      const visible = visibleSubtypes.has(subtype);
      subtypeEntityMap[subtype].forEach(ent => ent.show = visible);
    }
  });
}


  function processGeoJSON(data) {
    const reprojected = reprojectGeoJSON(data);
    Cesium.GeoJsonDataSource.load(reprojected, { clampToGround: false }).then(dataSource => {
      viewer.dataSources.add(dataSource);
      viewer.zoomTo(dataSource);
      const entities = dataSource.entities.values;
      let baseHeight = 0;
      for (let entity of entities) {
        const sub = entity.properties?.SUB_TYPE?.getValue(Cesium.JulianDate.now()) || "";
        const h = parseFloat(entity.properties?.HEIGHT?.getValue(Cesium.JulianDate.now()) || 0);
        if (sub.toLowerCase() === "kedeli") baseHeight = h;
      }
      for (let entity of entities) {
        if (!entity.polygon) continue;
        const sub = (entity.properties?.SUB_TYPE?.getValue(Cesium.JulianDate.now()) || "").toLowerCase();
        const h = parseFloat(entity.properties?.HEIGHT?.getValue(Cesium.JulianDate.now()) || 0);
        const floor = parseInt(entity.properties?.FLOOR?.getValue(Cesium.JulianDate.now()) || 0);
        const base = baseHeight * (floor - 1);
        const poly = entity.polygon;
        if (!subtypeEntityMap[sub]) subtypeEntityMap[sub] = [];
        subtypeEntityMap[sub].push(entity);
        switch (sub) {
          case "kedeli":
          case "kolona":
            poly.height = base;
            poly.extrudedHeight = base + h;
            poly.material = Cesium.Color.GRAY.withAlpha(0.8);
            break;
          case "fanjara":
            poly.height = base + ((baseHeight - h) / 2) + 0.3;
            poly.extrudedHeight = poly.height + h;
            poly.material = Cesium.Color.AQUA.withAlpha(0.8);
            break;
          case "iataki":
          case "aivani":
            poly.height = base;
            poly.extrudedHeight = base + 0.1;
            poly.material = Cesium.Color.BLACK.withAlpha(0.5);
            break;
          case "kibis ujredi":
            poly.height = base;
            poly.extrudedHeight = base + 0.3;
            poly.material = Cesium.Color.BLUE.withAlpha(0.8);
            viewer.entities.remove(entity);
            break;
          case "liftis saxta":
            poly.height = base;
            poly.extrudedHeight = base + baseHeight;
            poly.material = Cesium.Color.PINK.withAlpha(0.8);
            break;
          case "karebi":
            poly.height = base;
            poly.extrudedHeight = base + h;
            poly.material = Cesium.Color.BROWN.withAlpha(0.8);
            break;
          default:
            poly.height = base;
            poly.extrudedHeight = base + h;
            poly.material = Cesium.Color.BLACK.withAlpha(0.8);
        }
      }
      const treeData = buildJsTreeData(reprojected.features);
      initializeJsTree(treeData);
    });
  }

  processGeoJSON(inputGeojson);
</script>
</body>
</html>